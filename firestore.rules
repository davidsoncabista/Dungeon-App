rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regra Temporária: Permite que um usuário autenticado edite seu próprio documento, incluindo o 'role'.
    // Isso é necessário para restaurar o primeiro administrador.
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow create: if request.auth.uid != null;
    }

    // A regra original mais segura está comentada abaixo e será restaurada.
    /*
    match /users/{userId} {
      // Qualquer usuário autenticado pode ler a lista de usuários, mas não pode criar.
      // A criação é feita pela Cloud Function no backend.
      allow list: if request.auth != null;
      // Um usuário pode ler e atualizar seu próprio perfil.
      allow get, update: if request.auth.uid == userId;
      
      // Um administrador pode ler e escrever em qualquer perfil.
      allow get, list, update, delete: if request.auth.token.admin == true;

      // Um administrador pode alterar o 'role' de um usuário.
      // Ninguém mais pode alterar o campo 'role'.
      allow update: if request.auth.token.admin == true && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['role']);
    }
    */

    match /rooms/{roomId} {
      // Todos os usuários logados podem ler as salas.
      allow read: if request.auth != null;
      // Apenas administradores podem criar, editar ou excluir salas.
      allow write: if request.auth.token.admin == true;
    }

    match /bookings/{bookingId} {
        // Todos os usuários logados podem ler as reservas.
        allow list, get: if request.auth != null;

        // Usuário pode criar uma reserva se estiver autenticado.
        allow create: if request.auth != null;

        // O organizador da reserva ou um administrador podem atualizar ou excluir.
        allow update, delete: if resource.data.organizerId == request.auth.uid || request.auth.token.admin == true;
    }

    match /notices/{noticeId} {
      // Todos os usuários logados podem ler os avisos.
      allow read: if request.auth != null;
      // Apenas administradores podem criar, editar ou excluir avisos.
      allow write: if request.auth.token.admin == true;
    }

    match /plans/{planId} {
      // Todos os usuários logados podem ler os planos.
      allow read: if request.auth != null;
      // Apenas administradores podem criar, editar ou excluir planos.
      allow write: if request.auth.token.admin == true;
    }
  }
}
